<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QuartzSchedulerImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Fulcrum Quartz</a> &gt; <a href="index.source.html" class="el_package">org.apache.fulcrum.quartz.impl</a> &gt; <span class="el_source">QuartzSchedulerImpl.java</span></div><h1>QuartzSchedulerImpl.java</h1><pre class="source lang-java linenums">package org.apache.fulcrum.quartz.impl;

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */


import java.util.ArrayList;
import java.util.List;
import java.util.Properties;
import java.util.Set;

import org.apache.avalon.framework.activity.Disposable;
import org.apache.avalon.framework.activity.Initializable;
import org.apache.avalon.framework.activity.Startable;
import org.apache.avalon.framework.configuration.Configurable;
import org.apache.avalon.framework.configuration.Configuration;
import org.apache.avalon.framework.configuration.ConfigurationException;
import org.apache.avalon.framework.logger.AbstractLogEnabled;
import org.apache.avalon.framework.logger.LogEnabled;
import org.apache.avalon.framework.parameters.Parameters;
import org.apache.avalon.framework.service.ServiceException;
import org.apache.avalon.framework.service.ServiceManager;
import org.apache.avalon.framework.service.Serviceable;
import org.apache.avalon.framework.thread.ThreadSafe;
import org.apache.fulcrum.quartz.QuartzScheduler;
import org.quartz.Job;
import org.quartz.JobDetail;
import org.quartz.JobExecutionContext;
import org.quartz.JobExecutionException;
import org.quartz.JobKey;
import org.quartz.JobListener;
import org.quartz.Matcher;
import org.quartz.Scheduler;
import org.quartz.SchedulerException;
import org.quartz.Trigger;
import org.quartz.impl.StdSchedulerFactory;
import org.quartz.impl.matchers.GroupMatcher;

/**
 * Avalon service  wrapping the QuartzScheduler.
 */
<span class="fc" id="L58">public class QuartzSchedulerImpl</span>
        extends AbstractLogEnabled
        implements QuartzScheduler, Configurable, Serviceable, Disposable, Initializable, ThreadSafe, JobListener, Startable
{
    /** Configuration key */
    private static final String CONFIG_CONFIGURATION = &quot;configuration&quot;;

    /** Configuration key */
    private static final String CONFIG_PROPERTY_FILE = &quot;quartzPropertyFile&quot;;

    /** Configuration key */
    private static final String CONFIG_PROPERTIES = &quot;properties&quot;;

    /**
     * the Avalon service serviceManager
     */
    private ServiceManager serviceManager;

    /**
     * the Quartz scheduler instance
     */
    private Scheduler scheduler;

    /**
     * the quartz property file
     */
    private String quartzPropertyFile;

    /**
     * the quartz properties loaded from the XML configuration
     */
    private Properties quartzProperties;

    // === Avalon Lifecycle =================================================

    /**
     * @see org.apache.avalon.framework.configuration.Configurable#configure(org.apache.avalon.framework.configuration.Configuration)
     */
    @Override
    public void configure(Configuration conf) throws ConfigurationException
    {
<span class="fc" id="L99">        Configuration quartzConf = conf.getChild(CONFIG_CONFIGURATION, true);</span>

<span class="pc bpc" id="L101" title="1 of 2 branches missed.">        if(quartzConf.getChild(CONFIG_PROPERTIES, false) != null)</span>
        {
<span class="fc" id="L103">            this.quartzProperties = Parameters.toProperties(Parameters.fromConfiguration(quartzConf.getChild(CONFIG_PROPERTIES)));</span>
        }
<span class="nc bnc" id="L105" title="All 2 branches missed.">        else if(quartzConf.getChild(CONFIG_PROPERTY_FILE, false) != null)</span>
        {
<span class="nc" id="L107">            this.quartzPropertyFile = quartzConf.getChild(CONFIG_PROPERTY_FILE).getValue();</span>
        }
<span class="fc" id="L109">    }</span>

    /**
     * @see org.apache.avalon.framework.service.Serviceable#service(org.apache.avalon.framework.service.ServiceManager)
     */
    @Override
    public void service(ServiceManager manager) throws ServiceException
    {
<span class="fc" id="L117">        this.serviceManager = manager;</span>
<span class="fc" id="L118">    }</span>

    /**
     * @see org.apache.avalon.framework.activity.Initializable#initialize()
     */
    @Override
    public void initialize() throws Exception
    {
        // instantiating a specific scheduler from a property file or properties
<span class="fc" id="L127">        StdSchedulerFactory schedulerFactory = new StdSchedulerFactory();</span>
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">        if(this.quartzProperties != null)</span>
        {
<span class="fc" id="L130">            getLogger().info(&quot;Pulling quartz configuration from the container XML configuration&quot;);</span>
<span class="fc" id="L131">            schedulerFactory.initialize(this.quartzProperties);</span>
        }
<span class="nc bnc" id="L133" title="All 2 branches missed.">        else if(this.quartzPropertyFile != null)</span>
        {
<span class="nc" id="L135">            getLogger().info(&quot;Pulling quartz configuration from the following property file : &quot; + this.quartzPropertyFile);</span>
<span class="nc" id="L136">            schedulerFactory.initialize(this.quartzPropertyFile);</span>
        }
        else
        {
<span class="nc" id="L140">            getLogger().info(&quot;Using Quartz default configuration since no user-supplied configuration was found&quot;);</span>
<span class="nc" id="L141">            schedulerFactory.initialize();</span>
        }

<span class="fc" id="L144">        this.scheduler = schedulerFactory.getScheduler();</span>

        // add this service instance as JobListener to allow basic monitoring
<span class="fc" id="L147">        getScheduler().getListenerManager().addJobListener(this, new ArrayList&lt;Matcher&lt;JobKey&gt;&gt;());</span>
<span class="fc" id="L148">    }</span>

    @Override
    public void start() throws Exception
    {
<span class="fc" id="L153">        getScheduler().start();</span>

<span class="pc bpc" id="L155" title="1 of 2 branches missed.">        if(getLogger().isInfoEnabled())</span>
        {
<span class="fc" id="L157">            logSchedulerConfiguration();</span>
        }

<span class="fc" id="L160">    }</span>

    @Override
    public void stop() throws Exception
    {
<span class="fc" id="L165">        getScheduler().standby();</span>
<span class="fc" id="L166">    }</span>

    /**
     * @see org.apache.avalon.framework.activity.Disposable#dispose()
     */
    @Override
    public void dispose()
    {
        try
        {
            // shutdown() does not return until executing Jobs complete execution
<span class="fc" id="L177">            this.scheduler.shutdown(true);</span>
        }
<span class="nc" id="L179">        catch (SchedulerException e)</span>
        {
<span class="nc" id="L181">            this.getLogger().warn(&quot;Problem shutting down quartz scheduler &quot;, e);</span>
<span class="fc" id="L182">        }</span>

<span class="fc" id="L184">        this.scheduler = null;</span>
<span class="fc" id="L185">        this.serviceManager = null;</span>
<span class="fc" id="L186">    }</span>

    // === Service Interface Implementation =================================

    /**
     * @see org.apache.fulcrum.quartz.QuartzScheduler#getScheduler()
     */
    @Override
    public Scheduler getScheduler()
    {
<span class="fc" id="L196">        return scheduler;</span>
    }

    /**
     * Calls getName() on jobListener
     *
     * @see org.quartz.JobListener#getName()
     */
    @Override
    public String getName()
    {
<span class="fc" id="L207">        return getClass().getName();</span>
    }

    /**
     * Hook to support jobs implementing Avalon interface such as
     * LogEnabled and Serviceable.
     *
     * @see org.quartz.JobListener#jobToBeExecuted(org.quartz.JobExecutionContext)
     */
    @Override
    public void jobToBeExecuted(JobExecutionContext context)
    {
<span class="fc" id="L219">        Job job = context.getJobInstance();</span>

        // inject a logger instance
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">        if(job instanceof LogEnabled)</span>
        {
<span class="nc" id="L224">            ((LogEnabled) job).enableLogging(getLogger());</span>
        }

        // inject a ServiceManager instance
<span class="fc bfc" id="L228" title="All 2 branches covered.">        if (job instanceof Serviceable)</span>
        {
            try
            {
<span class="fc" id="L232">                ((Serviceable) job).service(serviceManager);</span>
            }
<span class="nc" id="L234">            catch (ServiceException e)</span>
            {
<span class="nc" id="L236">                getLogger().error(&quot;Error servicing Job[&quot; + job + &quot;]&quot;, e);</span>
<span class="fc" id="L237">            }</span>
        }
<span class="fc" id="L239">    }</span>

    /**
     * @see org.quartz.JobListener#jobWasExecuted(org.quartz.JobExecutionContext, org.quartz.JobExecutionException)
     */
    @Override
    public void jobWasExecuted(JobExecutionContext context, JobExecutionException ex)
    {
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">        if (ex != null)</span>
        {
<span class="nc" id="L249">            String msg = &quot;Executing the job '&quot; + context.getJobDetail().getKey() + &quot;' failed&quot;;</span>
<span class="nc" id="L250">            getLogger().error(msg, ex.getCause());</span>
<span class="nc" id="L251">        }</span>
        else
        {
<span class="pc bpc" id="L254" title="1 of 2 branches missed.">            if (getLogger().isDebugEnabled())</span>
            {
<span class="nc" id="L256">                getLogger().debug(&quot;Executing the job '&quot; + context.getJobDetail().getKey() + &quot;' took &quot; + context.getJobRunTime() + &quot; ms&quot;);</span>
            }
        }
<span class="fc" id="L259">    }</span>

    /**
     * @see org.quartz.JobListener#jobExecutionVetoed(org.quartz.JobExecutionContext)
     */
    @Override
    public void jobExecutionVetoed(JobExecutionContext context)
    {
        // nothing to do
<span class="nc" id="L268">    }</span>

    // === Service Implementation ===========================================
    /**
     * @throws SchedulerException generic exception
     */
    private void logSchedulerConfiguration() throws SchedulerException
    {
<span class="fc bfc" id="L276" title="All 2 branches covered.">        for (String jobGroup : getScheduler().getJobGroupNames())</span>
        {
<span class="fc" id="L278">            Set&lt;JobKey&gt; jobsInGroup = getScheduler().getJobKeys(GroupMatcher.jobGroupEquals(jobGroup));</span>
<span class="fc" id="L279">            getLogger().info(&quot;Job Group: &quot; + jobGroup + &quot; contains the following number of jobs : &quot; + jobsInGroup.size());</span>
<span class="fc bfc" id="L280" title="All 2 branches covered.">            for (JobKey jobKey : jobsInGroup)</span>
            {
<span class="fc" id="L282">                StringBuilder buffer = new StringBuilder();</span>
<span class="fc" id="L283">                JobDetail jobDetail = getScheduler().getJobDetail(jobKey);</span>
<span class="fc" id="L284">                List&lt;? extends Trigger&gt; jobTriggers = getScheduler().getTriggersOfJob(jobKey);</span>
<span class="fc" id="L285">                buffer.append(jobDetail.getKey());</span>
<span class="fc" id="L286">                buffer.append(&quot; =&gt; &quot;);</span>
<span class="pc bpc" id="L287" title="2 of 4 branches missed.">                if(jobTriggers != null &amp;&amp; !jobTriggers.isEmpty())</span>
                {
<span class="fc" id="L289">                    Trigger jt = jobTriggers.get(0);</span>
<span class="fc" id="L290">                    buffer.append(jt.getKey());</span>
<span class="fc" id="L291">                    buffer.append(&quot; (&quot;);</span>
<span class="fc" id="L292">                    buffer.append(jt.getNextFireTime());</span>
<span class="fc" id="L293">                    buffer.append(&quot;)&quot;);</span>
<span class="fc" id="L294">                }</span>
                else
                {
<span class="nc" id="L297">                    buffer.append(&quot;no trigger defined&quot;);</span>
                }

<span class="fc" id="L300">                getLogger().info(buffer.toString());</span>
<span class="fc" id="L301">            }</span>
<span class="fc" id="L302">        }</span>
<span class="fc" id="L303">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>